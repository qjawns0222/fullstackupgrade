제목: [Fullstack] ShedLock + Redis: 분산 환경 스케줄링 중복 방지

오늘 백엔드 코드를 훑어보다가 배치 스케줄러(BatchScheduler.kt)가 눈에 띄었다. @Scheduled 어노테이션으로 매주 월요일 아침 9시에 기술 트렌드 분석 작업을 돌리게 되어 있었는데, 문득 이런 시나리오가 떠올랐다.

"만약 트래픽이 늘어서 서버를 2대, 3대로 늘리면 어떻게 되지?"

스프링의 기본 스케줄러는 각 인스턴스마다 독립적으로 동작한다. 즉, 서버가 3대면 월요일 아침 9시에 똑같은 배치가 3번 실행된다는 소리다. DB에 똑같은 데이터가 3배로 쌓이거나, 메일이 중복 발송되는 끔찍한 상황이 발생할 수 있다. 이건 시니어 개발자로서 용납할 수 없는 구조적 결함이다.

그래서 기존의 Circuit Breaker 같은 건 다 제쳐두고, 당장 급한 불인 '스케줄링 중복 실행'을 막기 위해 ShedLock을 도입하기로 했다.

ShedLock은 DB나 Redis 같은 공유 저장소에 락(Lock)을 걸어서, 여러 서버 중 오직 한 곳에서만 스케줄러가 실행되도록 보장해주는 라이브러리다. 우리 프로젝트는 이미 Redis를 쓰고 있으니, RedisLockProvider를 붙이는 건 식은 죽 먹기다.

작업은 간단했다.
build.gradle에 shedlock-spring과 redis-provider 의존성을 추가하고, ShedLockConfig 설정 클래스를 만들어서 Redis와 연결해줬다.
그리고 스케줄러 메소드에 @SchedulerLock 어노테이션을 딱 붙여주니 끝. lockAtMostFor 옵션으로 혹시나 작업이 죽어서 락이 안 풀리는 상황까지 대비했다.

테스트도 돌려봤는데 설정이 깔끔하게 로드된다. 이제 서버를 오토스케일링으로 무한히 늘려도 배치는 우직하게 한 놈만 실행될 것이다.

인프라 확장을 고려하지 않은 코드는 시한폭탄과 같다. 오늘 그 폭탄의 뇌관을 미리 제거해서 속이 다 시원하다. 역시 백엔드는 이런 견고함을 다지는 맛에 하는 것 같다.
